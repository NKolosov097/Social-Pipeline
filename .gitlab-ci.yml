image: node

stages:
    - install
    - test
    - deploy

install: 
    stage: install
    cache:
      key: install-cache
      paths:
        - node_modules/
    script:
        - npm install

test:
    stage: test
    script:
        - npm run lint
        - npm run test
    except:
        - main


test-coverage:
    stage: test
    cache:
      key: build-cache
      paths:
        - coverage/
    artifacts:
      paths:
        - coverage/
    script:
        - npm run lint
        - npm test -- --coverage
    only:
        - main

deploy:
    stage: deploy
    artifacts:
      paths:
        - build/
      expire_in: 4 week
    only:
        - main
    script:
        - npm run build

pages:
    stage: deploy
    dependencies:
      - test
    script:
      - mkdir .public
      - cp -r coverage/* .public
      - mv .public public
    artifacts:
      paths:
        - public
    only:
      - master